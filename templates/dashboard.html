<!DOCTYPE html>
<html>
<head>
    <title>ER Patient Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .deceased-row {
            background-color: #222 !important;
            color: white !important;
            opacity: 0.85;
        }
        .deceased-row s {
            color: #bbb;
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary px-3">
    <span class="navbar-brand">ER Patient Dashboard</span>
    <div>
        <a href="{{ url_for('add_patient') }}" class="btn btn-outline-light me-2">Add Patient</a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Logout</a>
    </div>
</nav>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary mb-0">ðŸ©º Patient Queue</h3>
        <input id="searchInput" class="form-control w-25" placeholder="Search by name / priority / notes / surgery / recommendation"
               onkeyup="filterTable()">
    </div>

    <table class="table table-hover bg-white shadow-sm" id="patientsTable">
        <thead class="table-dark">
        <tr>
            <th>Name</th>
            <th>HR</th>
            <th>BP</th>
            <th>O2</th>
            <th>Temp</th>
            <th>Priority</th>
            <th>Notes</th>
            <th>Surgery</th>
            <th>Recommendation</th>
            <th>Time of Death</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        {% for p in patients %}
        <tr class="{% if p['priority']=='Deceased' %} deceased-row {% endif %}">
            <td class="col-name">
                {% if p['priority']=='Deceased' %}
                    <s>{{ p["name"] }}</s>
                {% else %}
                    {{ p["name"] }}
                {% endif %}
            </td>
            <td>{{ p["hr"] }}</td>
            <td>{{ p["bp"] }}</td>
            <td>{{ p["oxygen"] }}</td>
            <td>{{ p["temp"] }}</td>

            <td class="col-priority">
                {% if p["priority"]=="Deceased" %}
                <span class="badge bg-dark">Deceased</span>
                {% elif p["priority"]=="Critical" %}
                <span class="badge bg-danger">Critical</span>
                {% elif p["priority"]=="High" %}
                <span class="badge bg-warning text-dark">High</span>
                {% elif p["priority"]=="Medium" %}
                <span class="badge bg-primary">Medium</span>
                {% else %}
                <span class="badge bg-success">Low</span>
                {% endif %}
            </td>

            <td class="col-notes">
                {% if p["notes"] %}
                    {{ p["notes"] }}
                {% else %}
                    -
                {% endif %}
            </td>

            <td class="col-surgery">
                {% if p["surgery_required"] == 1 %}
                <span class="badge bg-warning text-dark">Yes</span>
                {% else %}
                <span class="badge bg-secondary">No</span>
                {% endif %}
            </td>

            <td class="col-recommend">
                {{ p["recommendation"] }}
            </td>

            <td>
                {% if p["priority"]=="Deceased" %}
                    {{ p["time_of_death"] }}
                {% else %}
                    -
                {% endif %}
            </td>

            <td>
                <a href="/edit/{{ p.id }}" class="btn btn-primary btn-sm">Edit</a>
                <a href="/report/{{ p.id }}" class="btn btn-secondary btn-sm">Print</a>
                <a href="/delete/{{ p.id }}" class="btn btn-danger btn-sm"
                onclick="return confirm('Remove this record permanently?');">Delete</a>
            </td>


        </tr>
        {% endfor %}
        </tbody>
    </table>

    <hr class="my-4">

    <h3 class="text-center text-primary mb-4">ðŸ“Š Patient Analytics</h3>
    <div class="row">
        <div class="col-md-6">
            <canvas id="pieChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="barChart"></canvas>
        </div>
    </div>
</div>

<script>
function filterTable() {
    const filter = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#patientsTable tbody tr");

    rows.forEach(row => {
        const name = row.querySelector(".col-name").innerText.toLowerCase();
        const priority = row.querySelector(".col-priority").innerText.toLowerCase();
        const notes = row.querySelector(".col-notes").innerText.toLowerCase();
        const surgery = row.querySelector(".col-surgery").innerText.toLowerCase();
        const recommendation = row.querySelector(".col-recommend").innerText.toLowerCase();

        if (name.includes(filter) || priority.includes(filter) || notes.includes(filter)
            || surgery.includes(filter) || recommendation.includes(filter)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
}

const priorities = {{ priorities|tojson }};
const counts = {{ counts|tojson }};

const colorMap = {
    "Deceased": "black",
    "Critical": "red",
    "High": "orange",
    "Medium": "blue",
    "Low": "green"
};

const colors = priorities.map(p => colorMap[p] || "grey");

new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: { labels: priorities, datasets: [{ data: counts, backgroundColor: colors }] }
});

new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: { labels: priorities, datasets: [{ data: counts, backgroundColor: colors }] },
    options: { scales: { y: { beginAtZero: true } } }
});
</script>

</body>
</html>